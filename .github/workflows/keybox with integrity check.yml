name: keybox.xml generation & validity check
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  generate-keybox:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y openssl libssl-dev libxml2-utils
        pip install cryptography lxml

    - name: Generate keybox
      run: |
        git clone https://github.com/LRFP-Team/keyboxGenerator.git
        cd keyboxGenerator
        # ensure the print(keybox) is commented out in the script!
        python3 keyboxGenerator.py

    - name: Validate Keybox
      run: |
        cd keyboxGenerator
        if [ -f keybox.xml ] && [ $(wc -c < keybox.xml) -gt 2000 ]; then
          echo "✔ keybox.xml generated"
          echo "SHA256: $(sha256sum keybox.xml | cut -d' ' -f1)"
        else
          echo "✖ keybox generation failed"
          exit 1
        fi

        grep -A 50 "BEGIN CERTIFICATE" keybox.xml | head -n 50 > cert.pem
        if openssl x509 -in cert.pem -text -noout >/dev/null 2>&1; then
          echo "✔ certificate parses"
        else
          echo "⚠ certificate check skipped"
        fi

    - name: Encrypt ZIP
      env:
        ZIP_PASSWORD: ${{ secrets.KEYBOX_ZIP_PASSWORD }}
      run: |
        cd keyboxGenerator
        zip -P "$ZIP_PASSWORD" ../keybox-encrypted.zip keybox.xml
        cd ..
        echo "ZIP SHA256: $(sha256sum keybox-encrypted.zip | cut -d' ' -f1)"

    - name: Cleanup plaintext
      run: |
        rm -f keyboxGenerator/keybox.xml
        rm -f keyboxGenerator/cert.pem

    - name: Upload encrypted artifact
      uses: actions/upload-artifact@v4
      with:
        name: keybox-encrypted
        path: keybox-encrypted.zip
        retention-days: 30
